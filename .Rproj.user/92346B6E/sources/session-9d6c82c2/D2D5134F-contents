# --- REPLACE your existing export_for_webgestalt() with this version ---
# It guarantees a valid, non-empty SYMBOL list for ORA (adds a fallback if needed),
# writes clean UTF-8 text (no header), and keeps the ranked file unchanged.

export_for_webgestalt <- function(res_df, tag, out_dir, symbol_map,
                                  alpha = alpha_thresh,
                                  min_genes = 10,          # WebGestalt works best with >=10 genes
                                  fallback_top_n = 200,    # max extra genes to add if list is too small
                                  fallback_padj = 0.25) {  # relax padj to fill if needed
  rdf <- add_symbols_to_results(res_df, symbol_map)
  
  # ----- ORA list: SYMBOLS with padj < alpha -----
  ora <- rdf$symbol[!is.na(rdf$padj) & rdf$padj < alpha]
  
  clean_syms <- function(x) {
    x <- trimws(x)
    x <- x[nzchar(x)]
    x <- unique(x)
    sort(x)
  }
  ora <- clean_syms(ora)
  
  # Fallback: if too few genes, relax padj and take top by padj (still symbols only)
  if (length(ora) < min_genes) {
    cand <- rdf[!is.na(rdf$padj) & rdf$padj <= fallback_padj, c("symbol","padj")]
    cand <- cand[!is.na(cand$symbol) & nzchar(cand$symbol), , drop = FALSE]
    cand <- cand[order(cand$padj), , drop = FALSE]
    addl <- head(setdiff(cand$symbol, ora), fallback_top_n)
    ora  <- clean_syms(c(ora, addl))
  }
  
  # Write ORA list (one symbol per line, no header) in UTF-8 without BOM
  ora_file <- file.path(out_dir, paste0("WebGestalt_ORA_", tag, "_symbols.txt"))
  con <- file(ora_file, open = "w", encoding = "UTF-8")
  writeLines(ora, con = con, useBytes = TRUE)
  close(con)
  
  # ----- Ranked list for GSEA: (symbol, stat), no header, tab-separated -----
  rank_df <- rdf[, c("symbol", "stat")]
  rank_df <- rank_df[!is.na(rank_df$symbol) & nzchar(rank_df$symbol) & !is.na(rank_df$stat), , drop = FALSE]
  rank_df <- rank_df[order(abs(rank_df$stat), decreasing = TRUE), , drop = FALSE]
  rank_df <- rank_df[!duplicated(rank_df$symbol), , drop = FALSE]
  rank_file <- file.path(out_dir, paste0("WebGestalt_RANK_", tag, "_symbols.tsv"))
  write.table(rank_df, file = rank_file, sep = "\t", row.names = FALSE, col.names = FALSE,
              quote = FALSE, fileEncoding = "UTF-8")
  
  message(sprintf("Saved WebGestalt files for %s: ORA n=%d, RANK n=%d",
                  tag, length(ora), nrow(rank_df)))
}

# --- OPTIONAL: ensure a non-empty background (symbols of all tested genes) ---
# Run this once after DESeq2 to create/upload as "User-defined" reference in WebGestalt.
bg_ids <- rownames(dds)  # genes that passed filtering in DESeq2
bg_symbols <- ifelse(bg_ids %in% names(symbol_map) & nzchar(symbol_map[bg_ids]),
                     symbol_map[bg_ids], bg_ids)
bg_symbols <- sort(unique(trimws(bg_symbols[nzchar(bg_symbols)])))
bg_file <- file.path(res_dir, "github_export", "webgestalt", "WebGestalt_background_symbols.txt")
dir.create(dirname(bg_file), recursive = TRUE, showWarnings = FALSE)
con_bg <- file(bg_file, open = "w", encoding = "UTF-8")
writeLines(bg_symbols, con_bg, useBytes = TRUE)
close(con_bg)

# --- RE-GENERATE WebGestalt exports for all contrasts (overwrites previous) ---
for (nm in names(res_list)) {
  cur_res <- as.data.frame(res_list[[nm]])
  export_for_webgestalt(cur_res, nm, deseq_dir, symbol_map, alpha = alpha_thresh)
}
